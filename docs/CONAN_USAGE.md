# Conan Build System Guide

## Overview

FeuerBird uses **Conan 2.x** for dependency management and build configuration. Conan provides:

- **Reproducible builds** across Linux, macOS, and Windows
- **Multi-profile support**: Development, Release, Freestanding (for kernel)
- **Version pinning** via lockfiles for consistent builds
- **Cross-compilation** support for different architectures
- **Integration with CMake** for transparent build system usage

This guide explains how to use Conan with FeuerBird.

---

## Prerequisites

### Installation

**Install Conan 2.x** (requires Python 3.8+):

```bash
# Using pip (recommended)
pip install conan>=2.0

# Or via package manager
# Ubuntu/Debian:
sudo apt install conan
# macOS:
brew install conan
# Arch:
sudo pacman -S conan
```

**Verify installation**:

```bash
conan --version
# Expected output: Conan version 2.x.x
```

### Python and Git

```bash
# Python 3.8+ required
python3 --version

# Git required for version control
git --version
```

---

## Project Structure

```
feuerbird_exokernel/
├── conanfile.py                 # Conan configuration (main)
├── profiles/
│   ├── default.profile          # Default development profile
│   ├── release.profile          # Release optimized profile
│   ├── freestanding.profile     # Bare-metal kernel profile
│   └── debug.profile            # Debug with symbols
├── build/                       # CMake build directory (generated)
├── CMakeLists.txt              # CMake configuration
└── cmake/
    └── conan_toolchain.cmake    # Generated by Conan
```

---

## Quick Start

### 1. Install Dependencies

```bash
cd feuerbird_exokernel

# Install with default profile
conan install . -pr:h profiles/default.profile -pr:b profiles/default.profile

# This generates:
#   - build/ directory with CMake configuration
#   - conan_toolchain.cmake (CMake integration)
#   - conanbuild.cmake (build environment)
#   - conaninfo.txt (dependency information)
```

### 2. Configure CMake

```bash
# CMake uses Conan-generated toolchain automatically
cmake -S . -B build -G Ninja \
  -DCMAKE_TOOLCHAIN_FILE=build/generators/conan_toolchain.cmake \
  -DCMAKE_BUILD_TYPE=Debug
```

### 3. Build

```bash
# Ninja is configured by Conan
ninja -C build

# Output:
#   - build/kernel/kernel (kernel binary)
#   - build/tests/ (test executables)
#   - build/tools/ (utility tools)
```

### 4. Test

```bash
# Run tests (configured via CMake)
ctest --output-on-failure -C Debug
```

---

## Conan Profiles

Profiles define **compiler flags, optimization levels, and architecture-specific settings**.

### Default Profile (Development)

**File**: `profiles/default.profile`

```ini
[settings]
os=Linux
arch=x86_64
compiler=clang
compiler.version=21
compiler.libcxx=libcxx
build_type=Debug

[options]
shared=False

[conf]
tools.cmake.cmaketoolchain:generator=Ninja
tools.build:jobs=8
```

**Usage**:
```bash
conan install . -pr:h profiles/default.profile
```

**Characteristics**:
- Debug symbols enabled
- Optimizations disabled (faster compilation)
- Suitable for development and testing

### Release Profile

**File**: `profiles/release.profile`

```ini
[settings]
os=Linux
arch=x86_64
compiler=clang
compiler.version=21
compiler.libcxx=libcxx
build_type=Release

[options]
shared=False
enable_lto=True
enable_pgo=True

[conf]
tools.cmake.cmaketoolchain:generator=Ninja
tools.build:jobs=8
```

**Usage**:
```bash
conan install . -pr:h profiles/release.profile -pr:b profiles/release.profile
```

**Characteristics**:
- -O3 optimizations
- Link-Time Optimization (LTO) enabled
- Profile-Guided Optimization (PGO) enabled
- Suitable for production deployment

### Freestanding (Kernel) Profile

**File**: `profiles/freestanding.profile`

```ini
[settings]
os=Linux
arch=x86_64
compiler=clang
compiler.version=21
compiler.libcxx=libcxx
build_type=Debug

[options]
shared=False
kernel=True
freestanding=True

[conf]
tools.cmake.cmaketoolchain:generator=Ninja
tools.build:jobs=8
tools.build:compiler_executables="{'c': 'clang', 'cpp': 'clang++'}"
```

**Usage**:
```bash
conan install . -pr:h profiles/freestanding.profile
```

**Characteristics**:
- Bare-metal compatible (no libc)
- Suitable for kernel compilation
- Disables standard library dependencies

### Debug Profile

**File**: `profiles/debug.profile`

```ini
[settings]
os=Linux
arch=x86_64
compiler=clang
compiler.version=21
compiler.libcxx=libcxx
build_type=Debug

[options]
shared=False
enable_coverage=True
enable_asan=True
enable_ubsan=True

[conf]
tools.cmake.cmaketoolchain:generator=Ninja
tools.build:jobs=8
```

**Usage**:
```bash
conan install . -pr:h profiles/debug.profile
```

**Characteristics**:
- Debug symbols (-g)
- AddressSanitizer (memory errors)
- UndefinedBehaviorSanitizer (UB detection)
- Code coverage instrumentation

---

## Conanfile Configuration

**File**: `conanfile.py`

The main Conan configuration file defines dependencies and build options:

```python
from conan import ConanFile
from conan.tools.cmake import cmake_layout

class FeuerBirdConan(ConanFile):
    name = "feuerbird"
    version = "1.0.0"
    license = "GPL-3.0-or-later"
    url = "https://github.com/Oichkatzelesfrettschen/feuerbird_exokernel"

    # Binary settings
    settings = "os", "compiler", "build_type", "arch"

    # Options
    options = {
        "shared": [True, False],
        "kernel": [True, False],
        "freestanding": [True, False],
        "enable_coverage": [True, False],
        "enable_asan": [True, False],
        "enable_ubsan": [True, False],
        "enable_lto": [True, False],
        "enable_pgo": [True, False],
    }

    # Default values
    default_options = {
        "shared": False,
        "kernel": False,
        "freestanding": False,
        "enable_coverage": False,
        "enable_asan": False,
        "enable_ubsan": False,
        "enable_lto": False,
        "enable_pgo": False,
    }

    # Layout: build in build/ directory
    def layout(self):
        cmake_layout(self)

    # Generate CMake toolchain and environment
    def generate(self):
        tc = CMakeToolchain(self)
        tc.generate()

        # Additional environment setup
        env = VirtualBuildEnv(self)
        env.generate()
```

---

## Lockfiles for Reproducibility

Lockfiles ensure **identical builds across machines and over time**.

### Creating a Lockfile

```bash
# Generate lockfile from current configuration
conan lock create . -pr:h profiles/default.profile -pr:b profiles/default.profile

# Output: conan.lock (records all versions used)
```

### Using a Lockfile

```bash
# Install using locked versions (reproduces exact build)
conan install . --lockfile=conan.lock

# Subsequent builds use same dependency versions
# Prevents unexpected breaking changes
```

### Updating Lockfile

```bash
# Update to latest compatible versions
conan lock create . --update --lockfile=conan.lock

# Review changes before committing
git diff conan.lock
```

---

## Common Workflows

### Development Workflow

```bash
# 1. Install dependencies
conan install . -pr:h profiles/default.profile

# 2. Configure CMake
cmake -S . -B build -G Ninja \
  -DCMAKE_TOOLCHAIN_FILE=build/generators/conan_toolchain.cmake \
  -DCMAKE_BUILD_TYPE=Debug

# 3. Build
ninja -C build

# 4. Test
ctest -C Debug --output-on-failure

# 5. Make changes, rebuild
# Edit source code...
ninja -C build

# 6. Repeat step 4
ctest -C Debug --output-on-failure
```

### Release Build

```bash
# 1. Clean build directory (optional)
rm -rf build

# 2. Install with release profile
conan install . \
  -pr:h profiles/release.profile \
  -pr:b profiles/release.profile

# 3. Configure with Release mode
cmake -S . -B build -G Ninja \
  -DCMAKE_TOOLCHAIN_FILE=build/generators/conan_toolchain.cmake \
  -DCMAKE_BUILD_TYPE=Release

# 4. Build with LTO/PGO
ninja -C build

# 5. Strip binary
strip build/kernel/kernel

# 6. Verify
file build/kernel/kernel
ls -lh build/kernel/kernel
```

### Kernel Development

```bash
# 1. Install with freestanding profile
conan install . -pr:h profiles/freestanding.profile

# 2. Configure for kernel build
cmake -S . -B build -G Ninja \
  -DCMAKE_TOOLCHAIN_FILE=build/generators/conan_toolchain.cmake \
  -DCMAKE_BUILD_TYPE=Debug \
  -DKERNEL_ONLY=ON

# 3. Build kernel
ninja -C build kernel

# 4. Run in QEMU
qemu-system-x86_64 -kernel build/kernel/kernel -nographic

# 5. View boot output
./scripts/run_qemu.sh
```

### Cross-Platform Build

```bash
# For ARM64 (Apple Silicon, etc.)
conan install . \
  -s os=Linux \
  -s arch=armv8 \
  -pr:h profiles/default.profile

cmake -S . -B build \
  -DCMAKE_TOOLCHAIN_FILE=build/generators/conan_toolchain.cmake

ninja -C build
```

---

## CI/CD Integration

### GitHub Actions Example

```yaml
name: Build with Conan

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Conan
        run: pip install conan

      - name: Create Conan profile
        run: conan profile detect --force

      - name: Install dependencies
        run: conan install . \
          -pr:h profiles/default.profile \
          -pr:b profiles/default.profile

      - name: Configure CMake
        run: cmake -S . -B build -G Ninja \
          -DCMAKE_TOOLCHAIN_FILE=build/generators/conan_toolchain.cmake \
          -DCMAKE_BUILD_TYPE=Debug

      - name: Build
        run: ninja -C build

      - name: Test
        run: ctest --output-on-failure
```

### GitLab CI Example

```yaml
build:
  image: ubuntu:latest
  script:
    - apt update && apt install -y python3-pip ninja-build
    - pip install conan
    - conan profile detect --force
    - conan install . -pr:h profiles/default.profile
    - cmake -S . -B build -G Ninja \
        -DCMAKE_TOOLCHAIN_FILE=build/generators/conan_toolchain.cmake \
        -DCMAKE_BUILD_TYPE=Debug
    - ninja -C build
    - ctest --output-on-failure
```

---

## Dependency Management

### Adding Dependencies

Edit `conanfile.py`:

```python
def requirements(self):
    self.requires("zlib/1.2.13")
    self.requires("openssl/3.0.8")
    self.requires("boost/1.82.0")
```

Then reinstall:

```bash
conan install . --update
```

### Viewing Dependencies

```bash
# List installed dependencies
conan list "*"

# Show dependency tree
conan graph info . --format=json
```

### Version Ranges

```python
def requirements(self):
    self.requires("zlib/[>=1.2.11 <2]")  # Any 1.2.x >= 1.2.11
    self.requires("boost/[>=1.70]")      # Any 1.70 or later
```

---

## Troubleshooting

### Problem: "Missing prebuilt package"

**Cause**: Binary for configuration not available, must build from source

```
ERROR: Missing prebuilt package for zlib/1.2.13
```

**Solution**: Create profile for your configuration

```bash
conan profile detect --force
conan install . --build=missing
```

### Problem: "Compiler version mismatch"

**Cause**: Conan profile specifies different compiler version than available

```
ERROR: clang/21 not found
```

**Solution**: Use available compiler version

```bash
# Check installed compiler
clang --version

# Update profile
conan profile detect --force
```

### Problem: "Lockfile out of date"

**Cause**: New dependencies added but lockfile not updated

```
ERROR: Lockfile does not have all the recipes
```

**Solution**: Recreate lockfile

```bash
rm conan.lock
conan lock create .
```

### Problem: CMake can't find Conan toolchain

**Cause**: Toolchain path incorrect in CMake command

```
CMake Error: Could not find conan_toolchain.cmake
```

**Solution**: Ensure correct path and run `conan install` first

```bash
conan install .  # Generate generators/
cmake -S . -B build \
  -DCMAKE_TOOLCHAIN_FILE=build/generators/conan_toolchain.cmake
```

---

## Advanced Topics

### Generating Custom Profiles

```bash
# Auto-detect system configuration
conan profile detect --force

# Manual creation
conan profile new default
# Edit ~/.conan2/profiles/default

# List all profiles
conan profile list
```

### Build Options

Control build behavior via options:

```bash
conan install . -o *:shared=True
conan install . -o *:enable_coverage=True
conan install . -o *:enable_lto=False
```

### Custom Recipes

Create local recipes for your libraries:

```bash
mkdir -p recipes/mylib
cd recipes/mylib
conan new cmake_lib -f
# Edit conanfile.py, then
conan create . --build=missing
```

### Performance Tuning

```bash
# Use all CPU cores
conan install . -c tools.build:jobs=16

# Enable link-time optimization
conan install . -o *:enable_lto=True

# Enable PGO
conan install . -o *:enable_pgo=True
```

---

## Best Practices

### 1. Always Use Lockfiles for Production

```bash
# Development
conan install . -pr:h profiles/default.profile

# Production - use lockfile
conan install . --lockfile=conan.lock
```

### 2. Commit Profile Files

```bash
git add profiles/
git add conanfile.py
git commit -m "Build configuration"
```

### 3. Separate Host and Build Profiles

```bash
# When cross-compiling:
conan install . \
  -pr:h profiles/armv8.profile \
  -pr:b profiles/x86_64.profile
```

### 4. Clean Between Profile Changes

```bash
# Different profiles can conflict
rm -rf build

# Reinstall with new profile
conan install . -pr:h profiles/release.profile
```

### 5. Document Custom Options

```python
# In conanfile.py
def set_version(self):
    self.version = "1.0.0"

def config_options(self):
    # Custom option validation
    if self.settings.os == "Windows":
        del self.options.shared
```

---

## Integration with Development Tools

### VS Code

**File**: `.vscode/settings.json`

```json
{
  "cmake.configureOnOpen": true,
  "cmake.cacheInit": {
    "CMAKE_TOOLCHAIN_FILE": "${workspaceFolder}/build/generators/conan_toolchain.cmake"
  }
}
```

### JetBrains CLion

1. Open `CMakeLists.txt`
2. CMake toolchain automatically detected
3. File → Settings → Build, Execution, Deployment → CMake
4. Check "Custom toolchain": ensure `conan_toolchain.cmake` is set

### Makefile Integration

```makefile
build: conan cmake ninja

conan:
	conan install . -pr:h profiles/default.profile

cmake:
	cmake -S . -B build -G Ninja \
		-DCMAKE_TOOLCHAIN_FILE=build/generators/conan_toolchain.cmake

ninja:
	ninja -C build

clean:
	rm -rf build

.PHONY: build conan cmake ninja clean
```

---

## See Also

- [Conan Official Documentation](https://docs.conan.io/)
- `conanfile.py` - Project configuration
- `profiles/` - Build profiles
- `CMakeLists.txt` - CMake configuration
- `docs/TESTING_STRATEGY.md` - Testing with Conan
