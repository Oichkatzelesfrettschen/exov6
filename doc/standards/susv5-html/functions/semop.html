<!-- Copyright 2001-2024 IEEE and The Open Group, All Rights Reserved -->
<!DOCTYPE HTML>
<html lang="en">
<head>
<meta name="generator" content="HTML Tidy for HTML5 for Linux version 5.8.0">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<link type="text/css" rel="stylesheet" href="style.css"><!-- Generated by The Open Group rhtm tool v1.2.4 -->
<!-- Copyright (c) 2001-2024 The Open Group, All Rights Reserved -->
<title>semop</title>
</head>
<body bgcolor="white">
<div class="NAVHEADER">
<table summary="Header navigation table" class="nav" width="100%" border="0" cellpadding="0" cellspacing="0">
<tr class="nav">
<td class="nav" width="15%" align="left" valign="bottom"><a href="../functions/semget.html" accesskey="P">&lt;&lt;&lt;
Previous</a></td>
<td class="nav" width="70%" align="center" valign="bottom"><a href="contents.html">Home</a></td>
<td class="nav" width="15%" align="right" valign="bottom"><a href="../functions/send.html" accesskey="N">Next &gt;&gt;&gt;</a></td>
</tr>
</table>
<hr align="left" width="100%"></div>
<script language="JavaScript" src="../jscript/codes.js"></script><basefont size="3">
<center><font size="2">The Open Group Base Specifications Issue 8<br>
IEEE Std 1003.1-2024<br>
Copyright © 2001-2024 The IEEE and The Open Group</font></center>
<hr size="2" noshade>
<a name="top" id="top"></a> <a name="semop" id="semop"></a> <a name="tag_17_515" id="tag_17_515"></a><!-- semop -->
<h4 class="mansect"><a name="tag_17_515_01" id="tag_17_515_01"></a>NAME</h4>
<blockquote>semop — XSI semaphore operations</blockquote>
<h4 class="mansect"><a name="tag_17_515_02" id="tag_17_515_02"></a>SYNOPSIS</h4>
<blockquote class="synopsis">
<div class="box"><code><tt><sup>[<a href="javascript:open_code('XSI')">XSI</a>]</sup> <img src="../images/opt-start.gif" alt=
"[Option Start]" border="0"> #include &lt;<a href="../basedefs/sys_sem.h.html">sys/sem.h</a>&gt;<br>
<br>
int semop(int</tt> <i>semid</i><tt>, struct sembuf *</tt><i>sops</i><tt>, size_t</tt> <i>nsops</i><tt>); <img src=
"../images/opt-end.gif" alt="[Option End]" border="0"></tt></code></div>
<tt><br></tt></blockquote>
<h4 class="mansect"><a name="tag_17_515_03" id="tag_17_515_03"></a>DESCRIPTION</h4>
<blockquote>
<p>The <i>semop</i>() function operates on XSI semaphores (see XBD <a href="../basedefs/V1_chap04.html#tag_04_20"><i>4.20
Semaphore</i></a>). It is unspecified whether this function interoperates with the realtime interprocess communication facilities
defined in <a href="../functions/V2_chap02.html#tag_16_08"><i>2.8 Realtime</i></a>.</p>
<p>The <i>semop</i>() function shall perform atomically a user-defined array of semaphore operations in array order on the set of
semaphores associated with the semaphore identifier specified by the argument <i>semid</i>.</p>
<p>The argument <i>sops</i> is a pointer to a user-defined array of semaphore operation structures. The implementation shall not
modify elements of this array unless the application uses implementation-defined extensions.</p>
<p>The argument <i>nsops</i> is the number of such structures in the array.</p>
<p>Each structure, <b>sembuf</b>, includes the following members:</p>
<center>
<table border="1" cellpadding="3" align="center">
<tr valign="top">
<th align="center">
<p class="tent"><b>Member Type</b></p>
</th>
<th align="center">
<p class="tent"><b>Member Name</b></p>
</th>
<th align="center">
<p class="tent"><b>Description</b></p>
</th>
</tr>
<tr valign="top">
<td align="left">
<p class="tent"><b>unsigned short</b></p>
</td>
<td align="left">
<p class="tent"><i>sem_num</i></p>
</td>
<td align="left">
<p class="tent">Semaphore number.</p>
</td>
</tr>
<tr valign="top">
<td align="left">
<p class="tent"><b>short</b></p>
</td>
<td align="left">
<p class="tent"><i>sem_op</i></p>
</td>
<td align="left">
<p class="tent">Semaphore operation.</p>
</td>
</tr>
<tr valign="top">
<td align="left">
<p class="tent"><b>short</b></p>
</td>
<td align="left">
<p class="tent"><i>sem_flg</i></p>
</td>
<td align="left">
<p class="tent">Operation flags.</p>
</td>
</tr>
</table>
</center>
<p class="tent">Each semaphore operation specified by <i>sem_op</i> is performed on the corresponding semaphore specified by
<i>semid</i> and <i>sem_num</i>.</p>
<p class="tent">If all of the semaphore operations complete successfully, <i>semop</i>() shall return 0. If a semaphore operation
fails or blocks, all changes to <i>semadj</i> and <i>semval</i> values performed by completed semaphore operations in the array
before the operation that failed or blocked shall be undone before <i>semop</i>() returns or blocks, respectively. When a semaphore
operation blocks, the change to <i>semncnt</i> or <i>semzcnt</i> indicating which semaphore operation blocked shall not be undone
until the operation unblocks.</p>
<p class="tent">For each operation in the array of semaphore operations, the variable <i>sem_op</i> specifies one of three
semaphore operations:</p>
<ol>
<li class="tent">If <i>sem_op</i> is a negative integer and the calling process has alter permission, one of the following shall
occur:
<ul>
<li class="tent">If <i>semval</i> (see <a href="../basedefs/sys_sem.h.html"><i>&lt;sys/sem.h&gt;</i></a>) is greater than or equal
to the absolute value of <i>sem_op</i>, the absolute value of <i>sem_op</i> shall be subtracted from <i>semval</i>. Also, if
(<i>sem_flg</i> & SEM_UNDO) is non-zero, the absolute value of <i>sem_op</i> shall be added to the <i>semadj</i> value of the
calling process for the specified semaphore. If this is not the last operation in the array of semaphore operations to be
performed, processing shall continue with the next operation in the array.</li>
<li class="tent">If <i>semval</i> is less than the absolute value of <i>sem_op</i> and (<i>sem_flg</i> & IPC_NOWAIT) is non-zero,
the operation shall fail with <i>errno</i> set to [EAGAIN].</li>
<li class="tent">If <i>semval</i> is less than the absolute value of <i>sem_op</i> and (<i>sem_flg</i> & IPC_NOWAIT) is 0,
<i>semop</i>() shall increment the <i>semncnt</i> associated with the specified semaphore and suspend execution of the calling
thread (block) until one of the following conditions occurs:
<ul>
<li class="tent">The value of <i>semval</i> changes. When this occurs, the value of <i>semncnt</i> associated with the specified
semaphore shall be decremented and the array of semaphore operations shall be reevaluated.</li>
<li class="tent">The <i>semid</i> for which the calling thread is awaiting action is removed from the system. When this occurs, the
operation shall fail with <i>errno</i> set to [EIDRM].</li>
<li class="tent">The calling thread receives a signal that is to be caught. When this occurs, the value of <i>semncnt</i>
associated with the specified semaphore shall be decremented, and the calling thread shall resume execution in the manner
prescribed in <a href="../functions/sigaction.html#"><i>sigaction</i>()</a>.</li>
</ul>
</li>
</ul>
</li>
<li class="tent">If <i>sem_op</i> is a positive integer and the calling process has alter permission, the value of <i>sem_op</i>
shall be added to <i>semval</i> and, if (<i>sem_flg</i> & SEM_UNDO) is non-zero, the value of <i>sem_op</i> shall be subtracted
from the <i>semadj</i> value of the calling process for the specified semaphore. If this is not the last operation in the array of
semaphore operations to be performed, processing shall continue with the next operation in the array.</li>
<li class="tent">If <i>sem_op</i> is 0 and the calling process has read permission, one of the following shall occur:
<ul>
<li class="tent">If <i>semval</i> is 0, this is a successful operation. If this is not the last operation in the array of semaphore
operations to be performed, processing shall continue with the next operation in the array.</li>
<li class="tent">If <i>semval</i> is non-zero and (<i>sem_flg</i> & IPC_NOWAIT) is non-zero, the operation shall fail with
<i>errno</i> set to [EAGAIN].</li>
<li class="tent">If <i>semval</i> is non-zero and (<i>sem_flg</i> & IPC_NOWAIT) is 0, <i>semop</i>() shall increment the
<i>semzcnt</i> associated with the specified semaphore and suspend execution of the calling thread (block) until one of the
following occurs:
<ul>
<li class="tent">The value of <i>semval</i> changes. When this occurs, the value of <i>semzcnt</i> associated with the specified
semaphore shall be decremented and the array of semaphore operations shall be reevaluated.</li>
<li class="tent">The <i>semid</i> for which the calling thread is awaiting action is removed from the system. When this occurs, the
operation shall fail with <i>errno</i> set to [EIDRM].</li>
<li class="tent">The calling thread receives a signal that is to be caught. When this occurs, the value of <i>semzcnt</i>
associated with the specified semaphore shall be decremented, and the calling thread shall resume execution in the manner
prescribed in <a href="../functions/sigaction.html#"><i>sigaction</i>()</a>.</li>
</ul>
</li>
</ul>
</li>
</ol>
<p class="tent">Upon successful completion of all of the semaphore operations specified in the array pointed to by <i>sops</i>, the
value of <i>sempid</i> for each semaphore specified in the array shall be set to the process ID of the calling process and the
<i>sem_otime</i> timestamp associated with the semaphore set shall be set to the current time, as described in <a href=
"../functions/V2_chap02.html#tag_16_07_01"><i>2.7.1 IPC General Description</i></a>.</p>
</blockquote>
<h4 class="mansect"><a name="tag_17_515_04" id="tag_17_515_04"></a>RETURN VALUE</h4>
<blockquote>
<p>Upon successful completion, <i>semop</i>() shall return 0; otherwise, it shall return -1 and set <i>errno</i> to indicate the
error.</p>
</blockquote>
<h4 class="mansect"><a name="tag_17_515_05" id="tag_17_515_05"></a>ERRORS</h4>
<blockquote>
<p>The <i>semop</i>() function shall fail if:</p>
<dl compact>
<dd></dd>
<dt>[E2BIG]</dt>
<dd>The value of <i>nsops</i> is greater than the system-imposed maximum.</dd>
<dt>[EACCES]</dt>
<dd>Operation permission is denied to the calling process; see <a href="../functions/V2_chap02.html#tag_16_07"><i>2.7 XSI
Interprocess Communication</i></a>.</dd>
<dt>[EAGAIN]</dt>
<dd>The operation would result in suspension of the calling thread but (<i>sem_flg</i> & IPC_NOWAIT) is non-zero.</dd>
<dt>[EFBIG]</dt>
<dd>The value of <i>sem_num</i> is greater than or equal to the number of semaphores in the set associated with <i>semid</i>.</dd>
<dt>[EIDRM]</dt>
<dd>The semaphore identifier <i>semid</i> is removed from the system.</dd>
<dt>[EINTR]</dt>
<dd>The <i>semop</i>() function was interrupted by a signal.</dd>
<dt>[EINVAL]</dt>
<dd>The value of <i>semid</i> is not a valid semaphore identifier, or the number of individual semaphores for which the calling
process requests a SEM_UNDO would exceed the system-imposed limit.</dd>
<dt>[ENOSPC]</dt>
<dd>The limit on the number of individual processes requesting a SEM_UNDO would be exceeded.</dd>
<dt>[ERANGE]</dt>
<dd>An operation would cause a <i>semval</i> to overflow the system-imposed limit, or an operation would cause a <i>semadj</i>
value to overflow the system-imposed limit.</dd>
</dl>
</blockquote>
<hr>
<div class="box"><em>The following sections are informative.</em></div>
<h4 class="mansect"><a name="tag_17_515_06" id="tag_17_515_06"></a>EXAMPLES</h4>
<blockquote>
<h5><a name="tag_17_515_06_01" id="tag_17_515_06_01"></a>Setting Values in Semaphores</h5>
<p class="tent">The following example sets the values of the two semaphores associated with the <i>semid</i> identifier to the
values contained in the <i>sb</i> array.</p>
<pre>
<tt>#include &lt;sys/sem.h&gt;
...
int semid;
struct sembuf sb[2];
int nsops = 2;
int result;
<br class="tent">
// Code to initialize semid.
...
<br class="tent">
// Adjust value of semaphore in the semaphore array semid.
sb[0].sem_num = 0;
sb[0].sem_op = -1;
sb[0].sem_flg = SEM_UNDO | IPC_NOWAIT;
sb[1].sem_num = 1;
sb[1].sem_op = 1;
sb[1].sem_flg = 0;
<br class="tent">
result = semop(semid, sb, nsops);
</tt></pre>
<h5><a name="tag_17_515_06_02" id="tag_17_515_06_02"></a>Creating a Semaphore Identifier</h5>
<p class="tent">The following example gets a semaphore key using the <a href="../functions/ftok.html"><i>ftok</i>()</a> function,
then creates or uses an existing semaphore set associated with that key using the <a href=
"../functions/semget.html"><i>semget</i>()</a> function.</p>
<p class="tent">If this process creates the semaphore set, the program uses a call to <i>semop</i>() to initialize it to the value
in the <i>sbuf</i> array. The number of processes that can execute concurrently is set to 2.</p>
<p class="tent">The final call to <i>semop</i>() acquires the semaphore and waits until it is free; the SEM_UNDO option releases
the semaphore when the process exits, waiting until there are less than two processes running concurrently.<br></p>
<pre>
<tt>#include &lt;errno.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;sys/sem.h&gt;
#include &lt;sys/stat.h&gt;
...
struct sembuf sbuf;
int semid;
key_t semkey;
...
// Get a key for the semaphore set.
if ((semkey = ftok("/tmp", 'a')) == (key_t) -1) {
    perror("IPC error: ftok");
    exit(1);
}
<br class="tent">
// Create the semaphore set associated with this key
if ((semid = semget(semkey, 1, IPC_CREAT | IPC_EXCL | S_IRUSR |
    S_IWUSR | S_IRGRP | S_IWGRP | S_IROTH | S_IWOTH)) != -1) {

    // Initialize the semaphore.
    sbuf.sem_num = 0;
    sbuf.sem_op = 2; // Set the number of runs without queuing.
    sbuf.sem_flg = 0;
    if (semop(semid, &amp;sbuf, 1) == -1) {
        perror("IPC error: semop");
        exit(1);
    }
} else if (errno == EEXIST) {

    // The semaphore set already exists; get its semaphore ID.
    if ((semid = semget(semkey, 0, 0)) == -1) {
        perror("IPC error 1: semget");
        exit(1);
    }
} else {
    perror("IPC error 2: semget");
    exit(1);
}

// Since the semget() initialized the semaphore to 0, the
// following semop() will block until the creating process
// completes the initialization above. Processes will also
// block in the following semop() call if two other processes
// have already passed this point and are still running.
sbuf.sem_num = 0;
sbuf.sem_op = -1;
sbuf.sem_flg = SEM_UNDO;
if (semop(semid, &amp;sbuf, 1) == -1) {
    perror("IPC Error: semop");
    exit(1);
}
</tt></pre></blockquote>
<h4 class="mansect"><a name="tag_17_515_07" id="tag_17_515_07"></a>APPLICATION USAGE</h4>
<blockquote>
<p>The POSIX Realtime Extension defines alternative interfaces for interprocess communication. Application developers who need to
use IPC should design their applications so that modules using the IPC routines described in <a href=
"../functions/V2_chap02.html#tag_16_07"><i>2.7 XSI Interprocess Communication</i></a> can be easily modified to use the alternative
interfaces.</p>
</blockquote>
<h4 class="mansect"><a name="tag_17_515_08" id="tag_17_515_08"></a>RATIONALE</h4>
<blockquote>
<p>None.</p>
</blockquote>
<h4 class="mansect"><a name="tag_17_515_09" id="tag_17_515_09"></a>FUTURE DIRECTIONS</h4>
<blockquote>
<p>None.</p>
</blockquote>
<h4 class="mansect"><a name="tag_17_515_10" id="tag_17_515_10"></a>SEE ALSO</h4>
<blockquote>
<p><a href="../functions/V2_chap02.html#tag_16_07"><i>2.7 XSI Interprocess Communication</i></a>, <a href=
"../functions/V2_chap02.html#tag_16_08"><i>2.8 Realtime</i></a>, <a href="../functions/exec.html#tag_17_129"></a><a href=
"../functions/exec.html">exec</a>, <a href="../functions/exit.html#tag_17_130"><i>exit</i>()</a>, <a href=
"../functions/fork.html#"><i>fork</i>()</a>, <a href="../functions/semctl.html#"><i>semctl</i>()</a>, <a href=
"../functions/semget.html#"><i>semget</i>()</a>, <a href="../functions/sem_close.html#"><i>sem_close</i>()</a>, <a href=
"../functions/sem_destroy.html#"><i>sem_destroy</i>()</a>, <a href="../functions/sem_getvalue.html#"><i>sem_getvalue</i>()</a>,
<a href="../functions/sem_init.html#"><i>sem_init</i>()</a>, <a href="../functions/sem_open.html#"><i>sem_open</i>()</a>,
<a href="../functions/sem_post.html#"><i>sem_post</i>()</a>, <a href="../functions/sem_trywait.html#"><i>sem_trywait</i>()</a>,
<a href="../functions/sem_unlink.html#"><i>sem_unlink</i>()</a></p>
<p class="tent">XBD <a href="../basedefs/V1_chap04.html#tag_04_20"><i>4.20 Semaphore</i></a>, <a href=
"../basedefs/sys_ipc.h.html"><i>&lt;sys/ipc.h&gt;</i></a>, <a href="../basedefs/sys_sem.h.html"><i>&lt;sys/sem.h&gt;</i></a>,
<a href="../basedefs/sys_types.h.html"><i>&lt;sys/types.h&gt;</i></a></p>
</blockquote>
<h4 class="mansect"><a name="tag_17_515_11" id="tag_17_515_11"></a>CHANGE HISTORY</h4>
<blockquote>
<p>First released in Issue 2. Derived from Issue 2 of the SVID.</p>
</blockquote>
<h4 class="mansect"><a name="tag_17_515_12" id="tag_17_515_12"></a>Issue 5</h4>
<blockquote>
<p>The note about use of POSIX Realtime Extension IPC routines has been moved from FUTURE DIRECTIONS to a new APPLICATION USAGE
section.</p>
</blockquote>
<h4 class="mansect"><a name="tag_17_515_13" id="tag_17_515_13"></a>Issue 7</h4>
<blockquote>
<p>SD5-XSH-ERN-171 is applied, updating the DESCRIPTION to clarify the order in which the operations in <i>sops</i> will be
performed when there are multiple operations.</p>
<p class="tent">POSIX.1-2008, Technical Corrigendum 1, XSH/TC1-2008/0538 [329,429], XSH/TC1-2008/0539 [345,428], XSH/TC1-2008/0540
[329,429], XSH/TC1-2008/0541 [335], and XSH/TC1-2008/0542 [291,429] are applied.</p>
</blockquote>
<h4 class="mansect"><a name="tag_17_515_14" id="tag_17_515_14"></a>Issue 8</h4>
<blockquote>
<p>Austin Group Defect 377 is applied, changing the EXAMPLES section.</p>
<p class="tent">Austin Group Defect 628 is applied, clarifying how <i>semop</i>() behaves when there is more than one operation in
the array specified by <i>sops</i>.</p>
</blockquote>
<div class="box"><em>End of informative text.</em></div>
<hr>
<p>&nbsp;</p>
<a href="#top"><span class="topOfPage">return to top of page</span></a><br>
<hr size="2" noshade>
<center><font size="2">UNIX® is a registered Trademark of The Open Group.<br>
POSIX™ is a Trademark of The IEEE.<br>
Copyright © 2001-2024 The IEEE and The Open Group, All Rights Reserved<br>
[ <a href="../mindex.html">Main Index</a> | <a href="../basedefs/contents.html">XBD</a> | <a href=
"../functions/contents.html">XSH</a> | <a href="../utilities/contents.html">XCU</a> | <a href="../xrat/contents.html">XRAT</a>
]</font></center>
<hr size="2" noshade>
<div class="NAVHEADER">
<table summary="Header navigation table" class="nav" width="100%" border="0" cellpadding="0" cellspacing="0">
<tr class="nav">
<td class="nav" width="15%" align="left" valign="bottom"><a href="../functions/semget.html" accesskey="P">&lt;&lt;&lt;
Previous</a></td>
<td class="nav" width="70%" align="center" valign="bottom"><a href="contents.html">Home</a></td>
<td class="nav" width="15%" align="right" valign="bottom"><a href="../functions/send.html" accesskey="N">Next &gt;&gt;&gt;</a></td>
</tr>
</table>
<hr align="left" width="100%"></div>
</body>
</html>
