name: FeuerBird Exokernel Unified CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

env:
  CC: clang
  CXX: clang++

jobs:
  unified-build:
    name: FeuerBird Exokernel Build & Test
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        config:
          - name: "Baseline Build"
            cmake_flags: ""
            build_type: "RelWithDebInfo"
          - name: "Modern LLVM (LLD+ThinLTO+Polly)"
            cmake_flags: "-DUSE_LLD=ON -DUSE_LTO=ON -DUSE_POLLY=ON"
            build_type: "Release"
          - name: "Security (AddressSanitizer)"
            cmake_flags: "-DENABLE_ASAN=ON"
            build_type: "Debug"
          - name: "Development (Debug+Features)"
            cmake_flags: "-DUSE_SIMD=ON -DIPC_DEBUG=ON"
            build_type: "Debug"
          - name: "Coverage"
            cmake_flags: "-DENABLE_COVERAGE=ON -DUSE_SIMD=ON"
            build_type: "Debug"
            
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install LLVM toolchain
        run: |
          set -euxo pipefail
          # Update package lists
          sudo apt-get update -y
          
          # Install core development tools
          sudo apt-get install -y \
            build-essential \
            clang-18 lld-18 llvm-18 llvm-18-dev llvm-18-tools \
            ninja-build cmake \
            bison flex \
            python3-pip \
            qemu-system-i386 qemu-system-x86_64
          
          # Set up LLVM alternatives for consistent versioning
          sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-18 100
          sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-18 100
          sudo update-alternatives --install /usr/bin/llvm-ar llvm-ar /usr/bin/llvm-ar-18 100
          sudo update-alternatives --install /usr/bin/ld.lld ld.lld /usr/bin/ld.lld-18 100
          sudo update-alternatives --install /usr/bin/opt opt /usr/bin/opt-18 100
          
          # Install Python dependencies
          python3 -m pip install --user pytest pre-commit
          
          # Verify toolchain
          clang --version
          ld.lld --version || true
          opt --version || true

      - name: Pre-commit checks
        if: matrix.config.name == 'Baseline Build'
        uses: pre-commit/action@v3.0.0

      - name: Configure CMake (${{ matrix.config.name }})
        run: |
          set -euxo pipefail
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ matrix.config.build_type }} \
            ${{ matrix.config.cmake_flags }}
          
      - name: Build FeuerBird Exokernel (${{ matrix.config.name }})
        run: |
          set -euxo pipefail
          ninja -C build -j $(nproc)
          
      - name: Validate build artifacts
        run: |
          set -euxo pipefail
          echo "=== Build Validation ==="
          ls -la build/
          
          # Check for key artifacts
          if [ -f build/kernel ]; then
            echo "‚úÖ Kernel binary present"
            file build/kernel
          else
            echo "‚ùå Kernel binary missing"
            find build -name "*kernel*" || true
          fi
          
          # Check for libraries
          echo "=== Libraries ==="
          find build -name "*.a" | head -10 || true
          
          # Check compilation database
          if [ -f build/compile_commands.json ]; then
            echo "‚úÖ Compilation database generated"
            wc -l build/compile_commands.json
          fi
          
      - name: Run unit tests
        if: matrix.config.name == 'Baseline Build'
        run: |
          set -euxo pipefail
          # Run Python unit tests (failures block CI)
          PATH="/home/runner/.local/bin:$PATH" pytest -v tests/ --tb=short

          # Run CMake tests (retry flaky tests up to 2 times)
          cd build && ctest --output-on-failure -j $(nproc) --repeat until-pass:2
          
      - name: Kernel binary validation
        if: matrix.config.name == 'Baseline Build'
        run: |
          set -euxo pipefail
          echo "=== Kernel Binary Validation ==="

          # Find kernel binary
          if [ -f build/kernel/kernel ]; then
            KERNEL=build/kernel/kernel
          elif [ -f build/kernel ]; then
            KERNEL=build/kernel
          else
            echo "ERROR: Kernel binary not found"
            exit 1
          fi

          # Verify ELF format
          file "$KERNEL" | grep -q "ELF 64-bit" || {
            echo "ERROR: Kernel is not a valid 64-bit ELF"
            exit 1
          }
          echo "ELF format validated"

          # Check for multiboot2 header (magic: 0xe85250d6)
          if xxd "$KERNEL" | grep -q "d650 52e8"; then
            echo "Multiboot2 header present"
          else
            echo "WARNING: Multiboot2 header not found (may be byte-order issue)"
          fi

          # Verify expected symbols are present
          REQUIRED_SYMBOLS="main64 boot_success_marker cap_table_alloc cap_verify"
          for sym in $REQUIRED_SYMBOLS; do
            if nm "$KERNEL" | grep -q "$sym"; then
              echo "Symbol $sym present"
            else
              echo "ERROR: Required symbol $sym missing"
              exit 1
            fi
          done

          # Report kernel size
          SIZE=$(stat --printf="%s" "$KERNEL")
          echo "Kernel size: $SIZE bytes ($((SIZE / 1024)) KB)"

          # Verify reasonable size (between 50KB and 10MB)
          if [ "$SIZE" -lt 51200 ] || [ "$SIZE" -gt 10485760 ]; then
            echo "WARNING: Kernel size seems unusual"
          fi

          echo "Kernel binary validation PASSED"

      - name: Generate coverage report
        if: matrix.config.name == 'Coverage'
        run: |
          set -euxo pipefail
          echo "=== Generating Coverage Report ==="

          # Run tests to generate profdata (ctest already ran, but run again for coverage)
          cd build
          LLVM_PROFILE_FILE="coverage-%p.profraw" ctest --output-on-failure -j $(nproc) || true

          # Merge profdata files
          llvm-profdata-18 merge -sparse coverage-*.profraw -o coverage.profdata

          # Generate coverage report
          if [ -f kernel/kernel ]; then
            llvm-cov-18 report kernel/kernel -instr-profile=coverage.profdata > coverage-summary.txt
            llvm-cov-18 export kernel/kernel -instr-profile=coverage.profdata -format=lcov > coverage.info
            cat coverage-summary.txt
          fi

      - name: Check coverage threshold
        if: matrix.config.name == 'Coverage'
        run: |
          set -euxo pipefail
          if [ -f build/coverage-summary.txt ]; then
            # Extract total coverage percentage
            COVERAGE=$(grep TOTAL build/coverage-summary.txt | awk '{print $NF}' | sed 's/%//' || echo "0")
            echo "Total coverage: ${COVERAGE}%"

            # Check threshold (start with 30% for initial enforcement, raise to 40% later)
            THRESHOLD=30
            if [ "$(echo "$COVERAGE < $THRESHOLD" | bc -l)" -eq 1 ]; then
              echo "WARNING: Coverage ${COVERAGE}% is below ${THRESHOLD}% threshold"
              echo "Consider adding more tests to improve coverage"
              # Don't fail yet - start with warning, enforce later
              # exit 1
            else
              echo "Coverage ${COVERAGE}% meets ${THRESHOLD}% threshold"
            fi
          else
            echo "WARNING: Coverage report not generated"
          fi

  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install LLVM toolchain
        run: |
          set -euxo pipefail
          sudo apt-get update -y
          sudo apt-get install -y \
            clang-18 clang-tools-18 \
            ninja-build cmake

          sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-18 100
          sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-18 100

      - name: Configure CMake for analysis
        run: |
          set -euxo pipefail
          cmake -S . -B build-analysis -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Run clang-tidy (CI mode)
        run: |
          set -euxo pipefail
          echo "=== Running clang-tidy Static Analysis (CI Mode) ==="
          cd build-analysis
          cmake --build . --target clang-tidy-ci 2>&1 || {
            echo "Static analysis failed. See details above."
            exit 1
          }

      - name: Upload clang-tidy report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: clang-tidy-report
          path: build-analysis/reports/clang-tidy-ci-report.txt
          if-no-files-found: ignore

  architecture-matrix:
    name: Multi-Architecture Test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'

    strategy:
      fail-fast: false
      matrix:
        arch: [x86_64, aarch64]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install cross-compilation toolchain
        run: |
          set -euxo pipefail
          sudo apt-get update -y
          sudo apt-get install -y \
            clang-18 lld-18 ninja-build cmake \
            gcc-aarch64-linux-gnu gcc-arm-linux-gnueabihf
            
      - name: Build for ${{ matrix.arch }}
        run: |
          set -euxo pipefail
          echo "Building FeuerBird Exokernel for ${{ matrix.arch }}..."
          cmake -S . -B build-${{ matrix.arch }} -G Ninja \
            -DARCH=${{ matrix.arch }} \
            -DCMAKE_BUILD_TYPE=Release
          ninja -C build-${{ matrix.arch }} kernel || true
          
      - name: Validate ${{ matrix.arch }} build
        run: |
          set -euxo pipefail
          ls -la build-${{ matrix.arch }}/ || true
          if [ -f build-${{ matrix.arch }}/kernel ]; then
            echo "‚úÖ ${{ matrix.arch }} kernel build successful"
            file build-${{ matrix.arch }}/kernel
          else
            echo "‚ö†Ô∏è  ${{ matrix.arch }} kernel build incomplete"
          fi

  build-validation:
    name: Final Validation
    runs-on: ubuntu-latest
    needs: [unified-build]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install minimal toolchain
        run: |
          sudo apt-get update -y
          sudo apt-get install -y clang-18 ninja-build cmake
          
      - name: Final validation build
        run: |
          set -euxo pipefail
          cmake -S . -B validation -G Ninja -DCMAKE_BUILD_TYPE=Release
          ninja -C validation kernel
          
      - name: FeuerBird metrics
        run: |
          set -euxo pipefail
          if [ -f tools/feuerbird_metrics.c ]; then
            clang -std=c2x -O2 tools/feuerbird_metrics.c -o tools/feuerbird_metrics || true
            ./tools/feuerbird_metrics validation/kernel 1 || true
          fi
          
      - name: Success report
        run: |
          set -euxo pipefail
          echo "üéâ FeuerBird Exokernel Unified CI PASSED"
          echo "‚úÖ CMake+ninja build system validated"
          echo "‚úÖ LLVM toolchain (clang/lld/lto/polly) functional"
          echo "‚úÖ Multi-configuration builds successful"
          echo "‚úÖ Architecture matrix tested"
          
          if [ -f validation/kernel ]; then
            echo "‚úÖ Final kernel artifact verified"
            file validation/kernel
          fi